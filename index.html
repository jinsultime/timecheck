<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì—°ì¥ê·¼ë¬´ ìë™ ê³„ì‚° ë„êµ¬</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
    h1 { color: #2c3e50; }
    input[type="file"] { margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    button { padding: 8px 16px; margin-top: 10px; cursor: pointer; }
    #message { color: red; margin-top: 10px; }
    .section { margin-top: 40px; }
    .total-row { font-weight: bold; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>ì—°ì¥ê·¼ë¬´ ìë™ ê³„ì‚° ë„êµ¬</h1>
  <input type="file" id="fileInput" accept=".xlsx" />
  <button onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  <div id="message"></div>

  <div class="section">
    <h2>ì§ì›ë³„ Â· ì¼ìë³„ ì—°ì¥ê·¼ë¬´</h2>
    <div id="dailyTable"></div>
  </div>

  <div class="section">
    <h2>ì§ì›ë³„ Â· ì›”ë³„ ì—°ì¥ê·¼ë¬´ í•©ì‚°</h2>
    <div id="monthlyTable"></div>
  </div>

  <script>
    let resultData = [];
    let monthlyResult = [];

    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });
        processData(json);
      };

      reader.readAsArrayBuffer(file);
    }

    function processData(data) {
      document.getElementById('message').textContent = '';

      // âœ… ë³‘í•©ì…€/ë¹ˆí–‰ ëŒ€ì‘
      const headerRowIndex = data.findIndex(row =>
        row.some(cell => String(cell || '').includes('ì¸ì¦ì¼ì‹œ'))
      );
      if (headerRowIndex === -1) {
        document.getElementById('message').textContent = 'ì—‘ì…€ íŒŒì¼ì—ì„œ [ì¸ì¦ì¼ì‹œ] ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      const headerRow = data[headerRowIndex].map(v => String(v || '').trim());
      const rows = data.slice(headerRowIndex + 1);
      const colIndex = {
        date: headerRow.indexOf('ì¸ì¦ì¼ì‹œ'),
        day: headerRow.indexOf('ìš”ì¼'),
        name: headerRow.indexOf('ì´ë¦„'),
        mode: headerRow.indexOf('ì¸ì¦ëª¨ë“œ')
      };

      let records = rows
        .filter(r => r[colIndex.date] && (r[colIndex.mode] === 'ì¶œê·¼' || r[colIndex.mode] === 'í‡´ê·¼'))
        .map(r => {
          let dateVal = r[colIndex.date];
          let dt;
          if (typeof dateVal === 'number') {
            // ì—‘ì…€ ì‹œë¦¬ì–¼ ë‚ ì§œ ì²˜ë¦¬
            dt = XLSX.SSF.parse_date_code(dateVal);
            dt = new Date(Date.UTC(dt.y, dt.m - 1, dt.d, dt.H, dt.M, dt.S));
          } else {
            // ë¬¸ìì—´ ë‚ ì§œ ì²˜ë¦¬
            let dateStr = String(dateVal).replace('ì˜¤ì „','AM').replace('ì˜¤í›„','PM');
            dt = new Date(dateStr);
          }
          return {
            name: r[colIndex.name],
            day: r[colIndex.day],
            datetime: dt,
            mode: r[colIndex.mode]
          };
        })
        .filter(r => !isNaN(r.datetime));

      if (!records.length) {
        document.getElementById('message').textContent = 'ì¶œê·¼/í‡´ê·¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      // ğŸ”¹ ì´ë¦„+ë‚ ì§œë³„ ì¶œí‡´ê·¼ ì‹œê°„ ê³„ì‚°
      let grouped = {};
      records.forEach(rec => {
        const dateKey = rec.datetime.toISOString().split('T')[0];
        const key = rec.name + '_' + dateKey;
        if (!grouped[key]) grouped[key] = { name: rec.name, date: dateKey, day: rec.day, in: null, out: null };
        if (rec.mode === 'ì¶œê·¼') {
          if (!grouped[key].in || rec.datetime < grouped[key].in) grouped[key].in = rec.datetime;
        } else {
          if (!grouped[key].out || rec.datetime > grouped[key].out) grouped[key].out = rec.datetime;
        }
      });

      // ğŸ”¹ ì¼ìë³„ ë°ì´í„° ìƒì„±
      resultData = Object.values(grouped).map(r => {
        let overtime = 0;
        if (r.out) {
          const baseHour = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].includes(r.day) ? 19 : 14;
          const base = new Date(r.date + 'T' + String(baseHour).padStart(2,'0') + ':00:00');
          overtime = Math.max(0, (r.out - base) / 3600000);
        }
        return {
          ì´ë¦„: r.name,
          ë‚ ì§œ: r.date,
          ìš”ì¼: r.day,
          ì¶œê·¼ì‹œê°„: r.in ? r.in.toTimeString().slice(0,5) : '',
          í‡´ê·¼ì‹œê°„: r.out ? r.out.toTimeString().slice(0,5) : '',
          ì—°ì¥ê·¼ë¬´ì‹œê°„: overtime.toFixed(2)
        };
      });

      // ğŸ”¹ ì§ì›ë³„ â†’ ë‚ ì§œìˆœ ì •ë ¬
      resultData.sort((a,b) => {
        if (a.ì´ë¦„ < b.ì´ë¦„) return -1;
        if (a.ì´ë¦„ > b.ì´ë¦„) return 1;
        return new Date(a.ë‚ ì§œ) - new Date(b.ë‚ ì§œ);
      });

      // ğŸ”¹ ì›”ë³„ í•©ì‚° ë°ì´í„° ìƒì„±
      let monthlyData = {};
      resultData.forEach(r => {
        const monthKey = r.ì´ë¦„ + '_' + r.ë‚ ì§œ.slice(0,7);
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = { ì´ë¦„: r.ì´ë¦„, ì›”: r.ë‚ ì§œ.slice(0,7), ì´ì—°ì¥ê·¼ë¬´ì‹œê°„: 0 };
        }
        monthlyData[monthKey].ì´ì—°ì¥ê·¼ë¬´ì‹œê°„ += parseFloat(r.ì—°ì¥ê·¼ë¬´ì‹œê°„);
      });

      // ë°°ì—´ ë³€í™˜ & ì •ë ¬ (ì—°ì¥ê·¼ë¬´ì‹œê°„ ë§ì€ ìˆœ)
      monthlyResult = Object.values(monthlyData);
      monthlyResult.sort((a,b) => b.ì´ì—°ì¥ê·¼ë¬´ì‹œê°„ - a.ì´ì—°ì¥ê·¼ë¬´ì‹œê°„);

      // ğŸ”¹ ì›”ë³„ í•©ê³„ í–‰ ì¶”ê°€
      const monthTotals = {};
      monthlyResult.forEach(r => {
        if (!monthTotals[r.ì›”]) monthTotals[r.ì›”] = 0;
        monthTotals[r.ì›”] += r.ì´ì—°ì¥ê·¼ë¬´ì‹œê°„;
      });
      Object.keys(monthTotals).forEach(month => {
        monthlyResult.push({ ì´ë¦„: 'ì´í•©', ì›”: month, ì´ì—°ì¥ê·¼ë¬´ì‹œê°„: monthTotals[month].toFixed(2) });
      });

      displayTable('dailyTable', resultData);
      displayTable('monthlyTable', monthlyResult);
    }

    function displayTable(containerId, data) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!data.length) return;

      const table = document.createElement('table');
      const header = Object.keys(data[0]);

      let thead = document.createElement('thead');
      let tr = document.createElement('tr');
      header.forEach(h => {
        let th = document.createElement('th');
        th.textContent = h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
      table.appendChild(thead);

      let tbody = document.createElement('tbody');
      data.forEach(row => {
        let tr = document.createElement('tr');
        if (row.ì´ë¦„ === 'ì´í•©') tr.classList.add('total-row');
        header.forEach(h => {
          let td = document.createElement('td');
          td.textContent = row[h];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // ğŸ”¹ ì—‘ì…€ ì‹œíŠ¸ ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
    function autoFitColumns(ws, data) {
      const colWidths = Object.keys(data[0]).map((k, i) =>
        Math.max(k.length, ...data.map(r => String(r[k]).length))
      );
      ws['!cols'] = colWidths.map(w => ({ wch: w + 2 }));
    }

    function downloadExcel() {
      if (!resultData.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      const wb = XLSX.utils.book_new();

      const ws1 = XLSX.utils.json_to_sheet(resultData);
      autoFitColumns(ws1, resultData);
      XLSX.utils.book_append_sheet(wb, ws1, 'ì¼ë³„ì—°ì¥ê·¼ë¬´');

      const ws2 = XLSX.utils.json_to_sheet(monthlyResult);
      autoFitColumns(ws2, monthlyResult);
      XLSX.utils.book_append_sheet(wb, ws2, 'ì›”ë³„í•©ì‚°');

      XLSX.writeFile(wb, 'ì—°ì¥ê·¼ë¬´_ê³„ì‚°ê²°ê³¼.xlsx');
    }
  </script>
</body>
</html>
